<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
	<title>Alexey Novakov Notes - spark</title>
	<subtitle>Alexey Novakov: Software Engineering Notes</subtitle>
	<link href="https://novakov-alexey.github.io/categories/spark/atom.xml" rel="self" type="application/atom+xml"/>
  <link href="https://novakov-alexey.github.io"/>
	<generator uri="https://www.getzola.org/">Zola</generator>
	<updated>2022-08-07T00:00:00+00:00</updated>
	<id>https://novakov-alexey.github.io/categories/spark/atom.xml</id>
	<entry xml:lang="en">
		<title>CDC with Delta Lake Streaming</title>
		<published>2022-08-07T00:00:00+00:00</published>
		<updated>2022-08-07T00:00:00+00:00</updated>
		<link rel="alternate" href="https://novakov-alexey.github.io/delta-lake/" type="text/html"/>
		<id>https://novakov-alexey.github.io/delta-lake/</id>
		<content type="html">

&lt;img src=&quot;https:&amp;#x2F;&amp;#x2F;novakov-alexey.github.io&amp;#x2F;processed_images&amp;#x2F;f04457750ffdcf1500.png&quot; class=&quot;center-image&quot;&#x2F;&gt;
&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;
&lt;p&gt;Change Data Capture (CDC) is a popular technique for replication of data from OLTP to OLAP data store.
Usually CDC tools integrate with transactional logs of relational databases and thus are mainly dedicated to replicate all possible data changes from relational databases. NoSQL databases are usually coming with built-in CDC for any possible data change (insert, update, delete), for example AWS DynamoDB Streams.&lt;&#x2F;p&gt;
&lt;p&gt;In this blog-post, we will look at &lt;a href=&quot;https:&#x2F;&#x2F;docs.delta.io&#x2F;latest&#x2F;index.html&quot;&gt;Delta Lake&lt;&#x2F;a&gt; table format, which supports &lt;a href=&quot;https:&#x2F;&#x2F;docs.delta.io&#x2F;latest&#x2F;delta-update.html#upsert-into-a-table-using-merge&quot;&gt;&amp;quot;merge&amp;quot;&lt;&#x2F;a&gt; operation. This operation is useful when we need to update replicated data in Data Lake.&lt;&#x2F;p&gt;
&lt;span id=&quot;continue-reading&quot;&gt;&lt;&#x2F;span&gt;&lt;h1 id=&quot;generate-data&quot;&gt;Generate Data&lt;&#x2F;h1&gt;
&lt;p&gt;Let&#x27;s generate some input data and merge it using Spark streaming API. Delta Lake API comes with DSL for merging data frames into into a table.&lt;&#x2F;p&gt;
&lt;p&gt;I have prepared a Scala script which can generate CSV files with hypotetical customer orders. Every few seconds this script creates a new file which contains few hundreds of rows.&lt;&#x2F;p&gt;
&lt;p&gt;Using &lt;a href=&quot;https:&#x2F;&#x2F;scala-cli.virtuslab.org&#x2F;&quot;&gt;Scala CLI&lt;&#x2F;a&gt;, run provided &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;novakov-alexey&#x2F;spark-elt-jobs&#x2F;blob&#x2F;main&#x2F;scripts&#x2F;csv-file-gen.scala&quot;&gt;csv-file-gen.scala&lt;&#x2F;a&gt; script. I am doing that within its cloned repository like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;scala-cli&lt;&#x2F;span&gt;&lt;span&gt; run scripts&#x2F;csv-file-gen.scala --main-class localGenerateOrders&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt; -- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;data&#x2F;gen&#x2F;orders&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; 3000
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It will start to print a number of generates rows in a new file. &lt;code&gt;3000&lt;&#x2F;code&gt; is pause in milliseconds after each file generation. Do not forget to stop this script afterwards, otherwise it will generate many files on your disk, but you should keep it running if you follow me and run the code below.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;create-delta-table&quot;&gt;Create Delta Table&lt;&#x2F;h1&gt;
&lt;p&gt;Using spark-shell, or any other tools which can initiate Spark session, for example Apache Zeppelin, Jupyter, run the code below:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;scala&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-scala &quot;&gt;&lt;code class=&quot;language-scala&quot; data-lang=&quot;scala&quot;&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; io&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;delta&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;tables&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;._
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; java&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;io&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;File
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val inputPath = new &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fbcbb;&quot;&gt;File&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;.&#x2F;data&#x2F;gen&#x2F;orders&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toURI&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toString
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val ordersDf =&lt;&#x2F;span&gt;&lt;span&gt; spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;read
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;option(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;inferSchema&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;true&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;option(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;header&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;true&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;csv(inputPath)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val tablePath = new &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fbcbb;&quot;&gt;File&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;.&#x2F;data&#x2F;delta&#x2F;orders&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toURI&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toString
&lt;&#x2F;span&gt;&lt;span&gt;ordersDf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;limit(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;write
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;format(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;delta&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;mode(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;overwrite&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;save(tablePath)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I am using Spark &lt;strong&gt;3.2.1&lt;&#x2F;strong&gt; with Scala &lt;strong&gt;2.12.15&lt;&#x2F;strong&gt; and &lt;strong&gt;Java 11.0.2&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;At this point we have a Delta table on the local file system. It is now ready for merging new changes using Spark batch or streaming queries.&lt;&#x2F;p&gt;
&lt;p&gt;In the above code, we are using already available generated files in &lt;code&gt;data&#x2F;gen&#x2F;orders&lt;&#x2F;code&gt; to create Delta Lake table itself. This is a requirement of Spark &lt;em&gt;streaming&lt;&#x2F;em&gt; API to provide input schema in advance&#x2F;staticaly.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;merge-streaming-data&quot;&gt;Merge streaming data&lt;&#x2F;h1&gt;
&lt;p&gt;Our goal is to discover new files in the input directory and merge their content to a Delta Lake table. Essentially, we are going to run micro-batch processing, which allows to reference an intermediate DataFrame to merge its content to existing Delta Lake table.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;scala&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-scala &quot;&gt;&lt;code class=&quot;language-scala&quot; data-lang=&quot;scala&quot;&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val orders = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fbcbb;&quot;&gt;DeltaTable&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;forPath(spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; tablePath) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#616e88;&quot;&gt;&#x2F;&#x2F; pointing to existing table
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We will use schema from existing &lt;code&gt;ordersDf&lt;&#x2F;code&gt; DataFrame to avoid manual schema definition, however you can also define required columns to be selected from intermiediate data frame for merge manually. &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;scala&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-scala &quot;&gt;&lt;code class=&quot;language-scala&quot; data-lang=&quot;scala&quot;&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; org&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;apache&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;sql&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;streaming&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;OutputMode
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; org&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;apache&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;sql&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;streaming&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Trigger
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; org&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;apache&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;sql&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;DataFrame
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val precombineKey = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;last_update_time&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val primaryKey = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;orderId&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val otherColumns =
&lt;&#x2F;span&gt;&lt;span&gt;    ordersDf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;schema&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;fields
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;map(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;_.&lt;&#x2F;span&gt;&lt;span&gt;name)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;filterNot(n &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;=&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; n &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; precombineKey || n &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; primaryKey)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#616e88;&quot;&gt;&#x2F;&#x2F; Function to upsert microBatchOutputDF into Delta table using merge
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;upsertToDelta&lt;&#x2F;span&gt;&lt;span&gt;(microBatchOutputDF: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fbcbb;&quot;&gt;DataFrame&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;batchId: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;Long&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#616e88;&quot;&gt;&#x2F;&#x2F; Find the latest change for each key based on the timestamp
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#616e88;&quot;&gt;&#x2F;&#x2F; Note: For nested structs, max on struct is computed as
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#616e88;&quot;&gt;&#x2F;&#x2F; max on first struct field, if equal fall back to second fields, and so on.  
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val latestChangeForEachKey =&lt;&#x2F;span&gt;&lt;span&gt; microBatchOutputDF
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;selectExpr(
&lt;&#x2F;span&gt;&lt;span&gt;      primaryKey&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;struct($precombineKey, ${otherColumns&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;mkString(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;,&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)}) as otherCols&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    )
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;groupBy(primaryKey)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;agg(max(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;otherCols&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;as(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;latest&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;selectExpr(primaryKey&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;latest.*&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;  orders&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;as(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;t&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;merge(
&lt;&#x2F;span&gt;&lt;span&gt;      latestChangeForEachKey&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;as(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;s&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;s.$primaryKey = t.$primaryKey&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;whenMatched()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;updateAll()
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;whenNotMatched()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;insertAll()
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;execute()
&lt;&#x2F;span&gt;&lt;span&gt;}    
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;runStream&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;= 
&lt;&#x2F;span&gt;&lt;span&gt;  spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;readStream
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;format(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;csv&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;schema(ordersDf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;schema)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;load(inputPath)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;writeStream
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;option(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;checkpointLocation&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;$tablePath&#x2F;_checkpoints&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;format(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;delta&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;foreachBatch(upsertToDelta &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;outputMode(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;update&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)    
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;start()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;runStream()
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once &lt;code&gt;start&lt;&#x2F;code&gt; method is executed, Spark starts to run a streaming job, which is going to merge all incoming data based on the primareKey &lt;code&gt;orderId&lt;&#x2F;code&gt; and its precombine key &lt;code&gt;last_update_time&lt;&#x2F;code&gt;. Precombine key is used to sort all records with the same primary key and then take the record with &lt;code&gt;max(..)&lt;&#x2F;code&gt; value. Usually, precombine key is a time-based column which can indidicate the latest transaction happened to a specific row.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;verify-merge-result&quot;&gt;Verify merge result&lt;&#x2F;h1&gt;
&lt;p&gt;In another spark-shell terminal we are checking that there is a maximum of 1 order per each unique &lt;code&gt;orderId&lt;&#x2F;code&gt;. If any of the &lt;code&gt;orderId&lt;&#x2F;code&gt; groups show more than 1 in the count column, then merge process is not working correctly.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;scala&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-scala &quot;&gt;&lt;code class=&quot;language-scala&quot; data-lang=&quot;scala&quot;&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; io&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;delta&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;tables&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;._
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; java&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;io&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;File
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val tablePath = new &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fbcbb;&quot;&gt;File&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;.&#x2F;data&#x2F;delta&#x2F;orders&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toURI&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toString
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val orders = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fbcbb;&quot;&gt;DeltaTable&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;forPath(spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; tablePath) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#616e88;&quot;&gt;&#x2F;&#x2F; pointing to existing table
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val primaryKey = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;orderId&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;orders&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toDF
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;groupBy(primaryKey)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;agg(count(primaryKey)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;as(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;count&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;sort(desc(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;count&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;show
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Output:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;+-------+-----+
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;orderId&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;count&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;+-------+-----+
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;148&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;463&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;471&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;496&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;833&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;243&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;392&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;540&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;623&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;737&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;858&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;897&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|     &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;516&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|     &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;85&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;137&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;251&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;451&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;580&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;808&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;+-------+-----+
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;only&lt;&#x2F;span&gt;&lt;span&gt; showing top 20 rows
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Prooving that there are no duplicates for any order:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;scala&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-scala &quot;&gt;&lt;code class=&quot;language-scala&quot; data-lang=&quot;scala&quot;&gt;&lt;span&gt;orders&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;toDF
&lt;&#x2F;span&gt;&lt;span&gt;res2
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;groupBy(primaryKey)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;agg(count(primaryKey)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;as(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;count&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;sort(desc(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;count&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;where(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;$&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;count&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; &amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;show
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Output:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;+-------+-----+
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;orderId&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;count&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;+-------+-----+
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;+-------+-----+
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Result is an empty dataset as expected.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;optimization&quot;&gt;Optimization&lt;&#x2F;h1&gt;
&lt;p&gt;If we process micro batches and merge them to Delta Lake table, then sooner or later Spark will create a lot of small Parquet files inside the table folder. Some of the files will be already obsolete and will be only needed if we query historical state of the Delta Lake table. In order to optimize table reads and writes, one should compact large number of files to get smaller number files in the table folder. &lt;strong&gt;Compaction&lt;&#x2F;strong&gt; can be done via standard Spark &lt;code&gt;repartition&lt;&#x2F;code&gt; operation.&lt;&#x2F;p&gt;
&lt;p&gt;Compact files:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;scala&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-scala &quot;&gt;&lt;code class=&quot;language-scala&quot; data-lang=&quot;scala&quot;&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;val numFiles = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;4
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;def &lt;&#x2F;span&gt;&lt;span style=&quot;color:#88c0d0;&quot;&gt;compact &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;= 
&lt;&#x2F;span&gt;&lt;span&gt;  spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;read
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;format(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;delta&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;load(tablePath)
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;repartition(numFiles)
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;write
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;option(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;dataChange&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;false&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;format(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;delta&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;mode(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;overwrite&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;save(tablePath)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;compact
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;dataChange=false&lt;&#x2F;code&gt; is Delta&#x27;s option here to minimize potential failure to other concurrent operations on the current Delta table.&lt;&#x2F;p&gt;
&lt;p&gt;Another way to get rid of large number of files is to run Delta&#x27;s &lt;strong&gt;vacuum&lt;&#x2F;strong&gt; operation, which effectively removes data files older than N number of hours.&lt;&#x2F;p&gt;
&lt;p&gt;Vacuum command deletes old files which are still part of the tables, but not used when you query the latest table state. However these files are still used if you query historical state of the table. So once you vacuum old files, you loose a possibility to query those historical data after that.&lt;&#x2F;p&gt;
&lt;p&gt;Below example removes all histoical data by setting &lt;code&gt;0&lt;&#x2F;code&gt; as number of hours.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;scala&quot; style=&quot;background-color:#2e3440;color:#d8dee9;&quot; class=&quot;language-scala &quot;&gt;&lt;code class=&quot;language-scala&quot; data-lang=&quot;scala&quot;&gt;&lt;span&gt;spark&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;conf&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;set(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;&amp;quot;spark.databricks.delta.retentionDurationCheck.enabled&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#eceff4;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;false&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;orders&lt;&#x2F;span&gt;&lt;span style=&quot;color:#81a1c1;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;vacuum(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;During the compaction or vacuum you may get an exception in the running Spark streaming or batch job which can terminate your job. The reason is that both processes, i.e. main job and compact&#x2F;vacuum, are trying to move table files around and thus may lead to a conflicting situations. But we remember that Delta Lake is ACID compliant, it should allow us to change data from multiple writers and still be consistent. It is still true. Delta Lake is based on &lt;a href=&quot;https:&#x2F;&#x2F;docs.delta.io&#x2F;latest&#x2F;concurrency-control.html#id1&quot;&gt;optimistic concurrency&lt;&#x2F;a&gt; principles which requires clients to retry their operations upon such failures&#x2F;exceptions. If you see such a failure, then make sure you repeat the same operation again or restart Spark job upon such exceptions. &lt;&#x2F;p&gt;
&lt;h1 id=&quot;summary&quot;&gt;Summary&lt;&#x2F;h1&gt;
&lt;p&gt;In this blog-post we have seen that Delta Lake can easily merge new data to existing table via standard Spark API, in this case via streaming API.
Apart from the main opearion we need to run compaction and vacuum operations time by time as a separate &lt;code&gt;houskeeping&lt;&#x2F;code&gt; jobs to get overal better peformance when reading the table data by the main data consumers.&lt;&#x2F;p&gt;
</content>
	</entry>
</feed>
